<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <meta charset="UTF-8" />
  <title>Entrenos Giovanni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg2: rgba(15, 23, 42, 0.5);
      --panel: rgba(2, 6, 23, 0.35);
      --line: rgba(148, 163, 184, 0.15);
      --text: #e2e8f0;
      --muted: rgba(226, 232, 240, 0.6);
      --accent: #38bdf8;
      --radius-lg: 1rem;
      --radius-md: .75rem;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    * { box-sizing: border-box; }
    body { margin:0; min-height:100vh; display:flex; flex-direction:column; }
    header {
      position:sticky; top:0; z-index:30;
      background:linear-gradient(180deg,#0f172a 0%,rgba(15,23,42,0) 100%);
      padding:1rem 1rem .5rem; backdrop-filter:blur(10px);
    }
    .container { width:min(1050px,100%); margin:0 auto; padding:0 1rem 5.5rem; }
    h1 { font-size:1.3rem; margin:0 0 .35rem; display:flex; gap:.5rem; align-items:center; }
    .small { font-size:.7rem; color:var(--muted); }
    .top-bar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom:.3rem; }
    select, textarea {
      background:rgba(2,6,23,.6); border:1px solid rgba(148,163,184,.2);
      border-radius:.6rem; color:var(--text); padding:.45rem .6rem; font-size:.85rem;
    }
    .card {
      background:var(--bg2); border:1px solid var(--line);
      border-radius:var(--radius-lg); padding:1rem; margin-top:1rem; width:100%;
    }
    .exercise { background:var(--panel); }
    .exercise-header {
      display:flex; justify-content:space-between; gap:1rem; align-items:flex-start; margin-bottom:.75rem;
    }
    .exercise-header h3 { margin:0 0 .35rem; font-size:.9rem; }
    .tags { display:flex; gap:.35rem; flex-wrap:wrap; justify-content:flex-end; }
    .tag {
      background:rgba(56,189,248,.1); border:1px solid rgba(56,189,248,.25);
      border-radius:9999px; padding:.2rem .6rem; font-size:.6rem; white-space:nowrap;
    }
    .info-line { font-size:.65rem; color:var(--muted); margin-bottom:.25rem; }
    .warmups,
    .sets,
    .cardio-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:.75rem;
      margin-bottom:.75rem;
      align-items:start;
    }
    .warmups-block,
    .cardio-field {
      background:rgba(15,23,42,.25);
      border:1px solid rgba(148,163,184,.03);
      border-radius:.6rem;
      padding:.45rem .55rem .5rem;
      min-height:60px;
    }
    .warmups-block strong { display:block; font-size:.65rem; margin-bottom:.15rem; }

    label { font-size:.65rem; margin-bottom:.25rem; display:block; }
    .set-field {
      background:rgba(15,23,42,.25);
      border:1px solid rgba(148,163,184,.03);
      border-radius:.6rem;
      padding:.45rem .55rem .5rem;
      display:flex;
      flex-direction:column;
      gap:.35rem;
    }
    input {
      width:100%; background:rgba(15,23,42,.35);
      border:1px solid rgba(148,163,184,.08);
      border-radius:.5rem; padding:.35rem .45rem;
      color:var(--text); font-size:.8rem;
    }
    input::placeholder { color:rgba(226,232,240,.35); }
    .field-hint { font-size:.6rem; color:var(--muted); }

    .rest-timer {
      display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin-top:.25rem;
    }
    .rest-timer button {
      background:rgba(226,232,240,.05);
      border:1px solid rgba(148,163,184,.2);
      color:var(--text);
      border-radius:.5rem;
      padding:.25rem .6rem;
      font-size:.7rem;
    }
    .rest-timer span { font-size:.7rem; color:var(--muted); min-width:3.5rem; text-align:right; }

    /* movilidad */
    .mob-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(230px, 1fr));
      gap:.75rem;
      margin-top:.75rem;
    }
    .mob-block {
      background:rgba(15,23,42,.25);
      border:1px solid rgba(148,163,184,.03);
      border-radius:.6rem;
      padding:.6rem .6rem .6rem;
      display:flex;
      flex-direction:column;
      gap:.45rem;
    }
    .mob-block h4 { margin:0; font-size:.78rem; }
    .mob-item {
      display:flex; gap:.5rem; align-items:center;
    }
    .mob-item label {
      flex:1;
      font-size:.68rem;
      line-height:1.25;
    }
    .mob-item input[type="checkbox"] {
      width:16px; height:16px;
    }

    .footer-actions {
      position:fixed; bottom:0; left:0; right:0;
      background:rgba(15,23,42,.9); border-top:1px solid rgba(148,163,184,.15);
      padding:.6rem 1rem .8rem; display:flex; gap:.6rem; justify-content:center; z-index:40;
    }
    button {
      background:var(--accent); border:none; border-radius:.7rem;
      padding:.45rem 1rem; font-weight:600; color:#0f172a; font-size:.8rem;
    }
    button.secondary { background:rgba(226,232,240,.03); border:1px solid rgba(148,163,184,.25); color:var(--text); }

    #history table { width:100%; border-collapse:collapse; }
    #history th,#history td { border-bottom:1px solid rgba(148,163,184,.1); padding:.35rem 0; font-size:.7rem; }
    .pr-badge { color:#f97316; font-size:.65rem; margin-left:.35rem; }

    /* MOBILE FIXES */
    @media (max-width: 540px) {
      header { padding: .8rem .6rem .4rem; }
      .container { padding: 0 .6rem 5.5rem; }
      .top-bar { flex-direction:column; align-items:flex-start; gap:.4rem; }
      .card { padding:.85rem .75rem .9rem; }
      .exercise-header { flex-direction:column; align-items:flex-start; }
      .warmups,
      .sets,
      .cardio-grid { grid-template-columns: 1fr; }
      .cardio-field select,
      .cardio-field input { width:100%; }
      .mob-grid { grid-template-columns: 1fr; }
      .rest-timer { justify-content:flex-start; }
      .footer-actions { justify-content:space-between; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Entrenos Giovanni <span class="small" id="todayDate"></span></h1>
      <div class="top-bar">
        <label class="small" for="viewSelect">Vista</label>
        <select id="viewSelect">
          <option value="strength-A">Fuerza ‚Äî D√≠a A</option>
          <option value="strength-B">Fuerza ‚Äî D√≠a B</option>
          <option value="cardio">Sesi√≥n de Aer√≥bicos</option>
          <option value="mobility">Movilidad / Postura</option>
        </select>
        <button id="loadBtn">Cargar</button>
        <span class="small" id="dayHint"></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="workoutContainer"></div>

    <div class="card">
      <h3 style="margin-top:0;">Notas r√°pidas</h3>
      <textarea id="notes" rows="3" placeholder="Dolor lumbar, RPE general, cardio m√°s tarde..."></textarea>
    </div>

    <div class="card" id="history" style="display:none;"></div>
  </main>

  <div class="footer-actions">
    <button id="saveBtn">Guardar sesi√≥n</button>
    <button class="secondary" id="viewHistoryBtn">Historial</button>
  </div>

  <script>
    // ======== FUERZA: PLAN A/B ========
    const WORKOUTS = {
      "A": [
        {
          name: "Squat (Barbell)",
          rest: "2‚Äì4 min",
          description: "Top set + 2 back-offs al 90%. T√©cnica y bracing.",
          warmupPercents: [0, 0.4, 0.6, 0.8],
          warmupReps: [8, 5, 3, "1‚Äì2"],
          defaultSets: [
            { label: "Set 1 (Top)", weight: 70, targetReps: 4 },
            { label: "Set 2 (90%)", weight: 63, targetReps: 5 },
            { label: "Set 3 (90%)", weight: 63, targetReps: 5 },
          ]
        },
        {
          name: "Bench Press (Barbell)",
          rest: "2‚Äì3 min",
          description: "Empuje principal del d√≠a.",
          defaultSets: [
            { label: "Set 1", weight: 50, targetReps: 8 },
            { label: "Set 2", weight: 50, targetReps: 8 },
            { label: "Set 3", weight: 50, targetReps: 8 },
          ]
        },
        {
          name: "Seated Row (Machine)",
          rest: "60‚Äì90 s",
          description: "Tir√≥n horizontal dominante.",
          defaultSets: [
            { label: "Set 1", weight: 60, targetReps: 10 },
            { label: "Set 2", weight: 60, targetReps: 10 },
            { label: "Set 3", weight: 60, targetReps: 10 },
            { label: "Set 4", weight: 60, targetReps: 10 },
          ]
        },
        {
          name: "Lat Pulldown",
          rest: "60‚Äì90 s",
          description: "Tir√≥n vertical, pecho arriba.",
          defaultSets: [
            { label: "Set 1", weight: 50, targetReps: 10 },
            { label: "Set 2", weight: 50, targetReps: 10 },
            { label: "Set 3", weight: 50, targetReps: 10 },
          ]
        },
        {
          name: "Face Pull",
          rest: "60 s",
          description: "Postura y deltoides posterior.",
          defaultSets: [
            { label: "Set 1", weight: 20, targetReps: 12 },
            { label: "Set 2", weight: 20, targetReps: 12 },
            { label: "Set 3", weight: 20, targetReps: 12 },
          ]
        },
        {
          name: "Core (Plancha 25s)",
          rest: "45‚Äì60 s",
          description: "3√ó25 s controlando lumbar.",
          defaultSets: [
            { label: "Set 1", weight: "25 s", targetReps: 1 },
            { label: "Set 2", weight: "25 s", targetReps: 1 },
            { label: "Set 3", weight: "25 s", targetReps: 1 },
          ]
        }
      ],
      "B": [
        {
          name: "Deadlift (Barbell)",
          rest: "2‚Äì4 min",
          description: "Top set + 2 back-offs, lumbar neutra.",
          warmupPercents: [0.4, 0.6, 0.8],
          warmupReps: [5, 3, "1‚Äì2"],
          defaultSets: [
            { label: "Set 1 (Top)", weight: 90, targetReps: 3 },
            { label: "Set 2 (90%)", weight: 80, targetReps: 5 },
            { label: "Set 3 (90%)", weight: 80, targetReps: 5 },
          ]
        },
        {
          name: "Overhead Press",
          rest: "2‚Äì3 min",
          description: "Empuje vertical, controlado.",
          defaultSets: [
            { label: "Set 1", weight: 30, targetReps: 8 },
            { label: "Set 2", weight: 30, targetReps: 8 },
            { label: "Set 3", weight: 30, targetReps: 8 },
          ]
        },
        {
          name: "Single Arm Row (DB)",
          rest: "60‚Äì90 s",
          description: "Tir√≥n unilateral, estabilidad.",
          defaultSets: [
            { label: "Set 1", weight: 26, targetReps: 10 },
            { label: "Set 2", weight: 26, targetReps: 10 },
            { label: "Set 3", weight: 26, targetReps: 10 },
          ]
        }
      ]
    };

    // ======== CARDIO ========
    const CARDIO_MODALITIES = [
      "Bici est√°tica / Spinning",
      "El√≠ptica",
      "Caminata cinta 2‚Äì6%",
      "Remo",
      "Piscina"
    ];
    const CARDIO_ZONES = [
      { label: "Zona 2 (110‚Äì128 lpm) ‚Äî RPE 3‚Äì4", value: "Z2" },
      { label: "Zona 3 (128‚Äì146 lpm) ‚Äî RPE 5‚Äì6", value: "Z3" },
      { label: "Picos controlados (155‚Äì170 lpm) ‚Äî RPE 7‚Äì8", value: "PICOS" }
    ];

    // ======== MOVILIDAD ========
    const MOBILITY_BLOCKS = [
      {
        title: "Daily Reset (8‚Äì10 min)",
        items: [
          "90/90 Hip Lift con reach ‚Äî 3√ó5 resp.",
          "Dead Bug ‚Äî 2√ó6‚Äì8",
          "Wall Slides ‚Äî 2√ó8‚Äì10",
          "Chin Tucks + Nods ‚Äî 2√ó8 (2 s)",
          "Short-Foot + Toe Splay ‚Äî 2√ó20‚Äì30 s/pie"
        ]
      },
      {
        title: "Pre-Fuerza A (sentadilla/rodilla)",
        items: [
          "Knee-to-Wall ‚Äî 2√ó8/lado",
          "Couch Stretch ‚Äî 2√ó30‚Äì40 s/lado",
          "90/90 Hip Lift ‚Äî 1√ó3 resp.",
          "Wall Slides ‚Äî 1√ó10",
          "Goblet Squat respirado ‚Äî 2√ó5"
        ]
      },
      {
        title: "Pre-Fuerza B (bisagra/peso muerto)",
        items: [
          "Hinge Drill con palo ‚Äî 2√ó8",
          "Soleus Raises ‚Äî 2√ó12",
          "Hamstring Sweep ‚Äî 2√ó8/lado",
          "Pallof Press ‚Äî 2√ó8/lado",
          "Serratus Punches ‚Äî 2√ó10"
        ]
      },
      {
        title: "Post-Fuerza (6‚Äì8 min)",
        items: [
          "Open Book ‚Äî 1√ó8/lado",
          "Extensi√≥n tor√°cica en foam ‚Äî 1‚Äì2 min",
          "Child‚Äôs Pose con exhalaci√≥n ‚Äî 1‚Äì2 min",
          "Pantorrilla a pared ‚Äî 1√ó30 s/√°ngulo"
        ]
      },
      {
        title: "Pies / Fascitis (3√ó/sem)",
        items: [
          "Gemelos de pie ‚Äî 3√ó12 @ 3-0-3",
          "S√≥leo sentado ‚Äî 3√ó12 @ 3-0-3",
          "Big-Toe Stretch ‚Äî 2√ó30 s/pie",
          "Rodillo/Bola fascia plantar ‚Äî 1‚Äì2 min/pie"
        ]
      }
    ];

    // ======== STORAGE ========
    function getSessions(){ return JSON.parse(localStorage.getItem("giovanni_workouts") || "[]"); }
    function saveSessions(s){ localStorage.setItem("giovanni_workouts", JSON.stringify(s)); }
    function todayStr(){ return new Date().toISOString().split("T")[0]; }
    document.getElementById("todayDate").textContent = todayStr();

    // ======== HELPERS ========
    function getExerciseHistory(exName){
      const all = getSessions().slice().reverse();
      const arr = [];
      all.forEach(sess => {
        (sess.exercises || []).forEach(ex => { if (ex.name === exName) arr.push(ex); });
      });
      return arr;
    }
    function roundTo2_5(num){ return Math.round(num / 2.5) * 2.5; }
    function estimate1RM(weight, reps){
      const w = Number(weight), r = Number(reps);
      if (!w || !r) return null;
      return w * (1 + r / 30);
    }
    function getBest1RMForExercise(exName){
      const hist = getExerciseHistory(exName);
      let best = 0;
      hist.forEach(ex => {
        ex.sets.forEach(s => {
          const e = estimate1RM(s.weight, s.reps);
          if (e && e > best) best = e;
        });
      });
      return best;
    }
    function restToSeconds(restStr){
      if (!restStr) return 60;
      const r = restStr.toLowerCase();
      if (r.includes("2‚Äì4") || r.includes("2-4")) return 180;
      if (r.includes("2‚Äì3") || r.includes("2-3")) return 150;
      if (r.includes("60‚Äì90") || r.includes("60-90")) return 75;
      if (r.includes("45‚Äì60") || r.includes("45-60")) return 50;
      if (r.includes("90 s")) return 90;
      if (r.includes("60 s") || r.includes("60s")) return 60;
      return 60;
    }
    function formatTime(s){
      const m = Math.floor(s/60), sec = s%60;
      return `${m.toString().padStart(2,"0")}:${sec.toString().padStart(2,"0")}`;
    }

    // ======== SEM√ÅFORO ========
    function getSuggestedWeight(exName, setIndex, defW){
      const history = getExerciseHistory(exName);
      if (!history.length) return defW;
      const last1 = history[0], last1set = last1.sets[setIndex];
      if (!last1set) return defW;
      if (history.length === 1) return Number(last1set.weight) || defW;
      const last2 = history[1], last2set = last2.sets[setIndex];
      if (!last2set) return Number(last1set.weight) || defW;

      const reps1 = Number(last1set.reps) || 0;
      const reps2 = Number(last2set.reps) || 0;
      const rpe1 = Number(last1set.rpe) || 0;
      const rpe2 = Number(last2set.rpe) || 0;
      const target1 = last1set.targetReps || 5;
      const target2 = last2set.targetReps || 5;
      const w1 = Number(last1set.weight) || defW;

      const good1 = reps1 >= target1 && (rpe1 === 0 || rpe1 <= 8);
      const good2 = reps2 >= target2 && (rpe2 === 0 || rpe2 <= 8);
      const bad1 = reps1 < target1 || (rpe1 !== 0 && rpe1 >= 9);
      const bad2 = reps2 < target2 || (rpe2 !== 0 && rpe2 >= 9);

      if (good1 && good2) return roundTo2_5(w1 + 2.5);
      if (bad1 && bad2) return Math.round((w1 * 0.9) * 10) / 10;
      return w1;
    }

    // ======== FUERZA (render) ========
    const activeTimers = {};
    function updateWarmupsForExercise(dayKey, exIndex){
      const ex = WORKOUTS[dayKey][exIndex];
      if (!ex.warmupPercents) return;
      const topInput = document.querySelector(`input[data-ex="${exIndex}"][data-set="0"][data-field="weight"]`);
      const topWeight = Number(topInput?.value) || ex.defaultSets[0].weight;
      const warmupContainer = document.querySelector(`#ex-${dayKey}-${exIndex} .warmups`);
      if (!warmupContainer) return;
      warmupContainer.innerHTML = "";
      ex.warmupPercents.forEach((p, i) => {
        const w = Math.round(topWeight * p);
        const repsText = ex.warmupReps && ex.warmupReps[i] ? ex.warmupReps[i] : "";
        const wb = document.createElement("div");
        wb.className = "warmups-block";
        wb.innerHTML = `<strong>W${i+1}</strong><span class="small">${w} kg √ó ${repsText}</span>`;
        warmupContainer.appendChild(wb);
      });
    }
    function startRestTimer(dayKey, exIndex){
      const ex = WORKOUTS[dayKey][exIndex];
      const secs = restToSeconds(ex.rest);
      const span = document.getElementById(`timer-${dayKey}-${exIndex}`);
      if (activeTimers[`${dayKey}-${exIndex}`]) clearInterval(activeTimers[`${dayKey}-${exIndex}`]);
      let remaining = secs;
      span.textContent = formatTime(remaining);
      activeTimers[`${dayKey}-${exIndex}`] = setInterval(() => {
        remaining--;
        span.textContent = formatTime(remaining);
        if (remaining <= 0){
          clearInterval(activeTimers[`${dayKey}-${exIndex}`]);
          span.textContent = "‚úÖ";
        }
      }, 1000);
    }
    function renderStrength(dayKey){
      const cont = document.getElementById("workoutContainer");
      cont.innerHTML = "";
      document.getElementById("dayHint").textContent = `Mostrando D√≠a ${dayKey}.`;
      WORKOUTS[dayKey].forEach((ex, exIndex) => {
        const card = document.createElement("div");
        card.className = "card exercise";
        card.id = `ex-${dayKey}-${exIndex}`;

        const header = document.createElement("div");
        header.className = "exercise-header";
        header.innerHTML = `
          <div>
            <h3>${ex.name}</h3>
            <div class="info-line">${ex.description || ""}</div>
          </div>
          <div class="tags">
            <span class="tag">Descanso: ${ex.rest}</span>
          </div>
        `;
        card.appendChild(header);

        if (ex.warmupPercents){
          const wDiv = document.createElement("div");
          wDiv.className = "warmups";
          card.appendChild(wDiv);
        }

        const setsDiv = document.createElement("div");
        setsDiv.className = "sets";
        ex.defaultSets.forEach((set, setIndex) => {
          const suggested = getSuggestedWeight(ex.name, setIndex, set.weight);
          const block = document.createElement("div");
          block.className = "set-field";
          block.innerHTML = `
            <label>${set.label} <span class="field-hint">(plan: ${set.weight} kg)</span></label>
            <input type="text" data-ex="${exIndex}" data-set="${setIndex}" data-field="weight" value="${suggested}" placeholder="peso (kg)" />
            <input type="text" data-ex="${exIndex}" data-set="${setIndex}" data-field="reps" placeholder="reps" />
            <input type="text" data-ex="${exIndex}" data-set="${setIndex}" data-field="rpe" placeholder="RPE" />
            <div class="field-hint">Objetivo: ${set.targetReps} reps</div>
          `;
          setsDiv.appendChild(block);
        });
        card.appendChild(setsDiv);

        const restDiv = document.createElement("div");
        restDiv.className = "rest-timer";
        restDiv.innerHTML = `
          <button type="button" data-rest-ex="${exIndex}">‚è± Descanso</button>
          <span id="timer-${dayKey}-${exIndex}">--:--</span>
        `;
        card.appendChild(restDiv);

        cont.appendChild(card);
      });

      WORKOUTS[dayKey].forEach((ex, exIndex) => updateWarmupsForExercise(dayKey, exIndex));

      const allTopInputs = document.querySelectorAll(`input[data-set="0"][data-field="weight"]`);
      allTopInputs.forEach(inp => {
        inp.addEventListener("input", (e) => {
          const exIndex = e.target.getAttribute("data-ex");
          updateWarmupsForExercise(dayKey, exIndex);
        });
      });

      const timerButtons = document.querySelectorAll(`button[data-rest-ex]`);
      timerButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const exIndex = btn.getAttribute("data-rest-ex");
          startRestTimer(dayKey, exIndex);
        });
      });
    }

    // ======== CARDIO (render) ========
    function renderCardio(){
      const cont = document.getElementById("workoutContainer");
      cont.innerHTML = "";
      document.getElementById("dayHint").textContent = "Aer√≥bico de bajo impacto (Zona 2 base).";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3 style="margin-top:0;">Plan Aer√≥bico ‚Äî Giovanni</h3>
        <p class="small">Objetivo: +gasto, h√≠gado graso, OSA, proteger lumbar/pies.</p>
        <div class="cardio-grid">
          <div class="cardio-field">
            <label>Modalidad</label>
            <select id="cardioMod">
              ${CARDIO_MODALITIES.map(m => `<option value="${m}">${m}</option>`).join("")}
            </select>
          </div>
          <div class="cardio-field">
            <label>Duraci√≥n (min)</label>
            <input type="text" id="cardioDur" value="30" />
          </div>
          <div class="cardio-field">
            <label>Intensidad / Zona</label>
            <select id="cardioZone">
              ${CARDIO_ZONES.map(z => `<option value="${z.value}">${z.label}</option>`).join("")}
            </select>
          </div>
          <div class="cardio-field">
            <label>RPE (opcional)</label>
            <input type="text" id="cardioRpe" placeholder="3‚Äì4" />
          </div>
        </div>
        <p class="small" style="margin-top:.25rem;">
          37 a√±os ‚Üí FC m√°x ‚âà 183 lpm. Zona 2: 110‚Äì128. Caminata: prioriza inclinaci√≥n antes que velocidad.
        </p>
      `;
      cont.appendChild(card);
    }

    // ======== MOVILIDAD (render) ========
    function renderMobility(){
      const cont = document.getElementById("workoutContainer");
      cont.innerHTML = "";
      document.getElementById("dayHint").textContent = "Movilidad y Postura ‚Äî bloques breves y repetibles.";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<h3 style="margin-top:0;">Plan de Movilidad y Postura ‚Äî Giovanni</h3>
        <p class="small">Exhala 6‚Äì7 s, costillas abajo, movimientos lentos. Marca lo que hagas hoy.</p>`;

      const grid = document.createElement("div");
      grid.className = "mob-grid";

      MOBILITY_BLOCKS.forEach((block, idx) => {
        const box = document.createElement("div");
        box.className = "mob-block";
        box.innerHTML = `<h4>${block.title}</h4>`;
        block.items.forEach((it, i2) => {
          const row = document.createElement("div");
          row.className = "mob-item";
          row.innerHTML = `
            <input type="checkbox" id="mob-${idx}-${i2}" />
            <label for="mob-${idx}-${i2}" class="small">${it}</label>
          `;
          box.appendChild(row);
        });
        grid.appendChild(box);
      });

      card.appendChild(grid);
      cont.appendChild(card);
    }

    // ======== GUARDAR ========
    function saveStrength(dayKey){
      const todayWorkout = WORKOUTS[dayKey];
      const exercisesData = [];
      todayWorkout.forEach((ex, exIndex) => {
        const sets = [];
        ex.defaultSets.forEach((set, setIndex) => {
          const wInput = document.querySelector(`input[data-ex="${exIndex}"][data-set="${setIndex}"][data-field="weight"]`);
          const rInput = document.querySelector(`input[data-ex="${exIndex}"][data-set="${setIndex}"][data-field="reps"]`);
          const rpeInput = document.querySelector(`input[data-ex="${exIndex}"][data-set="${setIndex}"][data-field="rpe"]`);
          const weightVal = wInput ? wInput.value : "";
          const repsVal = rInput ? rInput.value : "";
          const rpeVal = rpeInput ? rpeInput.value : "";

          const prevBest = getBest1RMForExercise(ex.name);
          const currentEst = estimate1RM(weightVal, repsVal);
          const isPR = currentEst && currentEst > prevBest;

          sets.push({
            label: set.label,
            weight: weightVal,
            reps: repsVal,
            rpe: rpeVal,
            targetReps: set.targetReps,
            est1RM: currentEst || null,
            isPR
          });
        });
        exercisesData.push({ name: ex.name, rest: ex.rest, sets });
      });
      const notes = document.getElementById("notes").value;
      const payload = { date: todayStr(), type: dayKey, notes, exercises: exercisesData };
      const all = getSessions();
      all.push(payload);
      saveSessions(all);
      alert("Sesi√≥n de fuerza guardada ‚úÖ");
    }

    function saveCardio(){
      const mod = document.getElementById("cardioMod").value;
      const dur = document.getElementById("cardioDur").value;
      const zone = document.getElementById("cardioZone").value;
      const rpe = document.getElementById("cardioRpe").value;
      const notes = document.getElementById("notes").value;
      const payload = {
        date: todayStr(),
        type: "Cardio",
        cardio: { modality: mod, duration: dur, zone, rpe },
        notes
      };
      const all = getSessions();
      all.push(payload);
      saveSessions(all);
      alert("Sesi√≥n de aer√≥bicos guardada ‚úÖ");
    }

    function saveMobility(){
      const done = [];
      MOBILITY_BLOCKS.forEach((block, idx) => {
        block.items.forEach((it, i2) => {
          const chk = document.getElementById(`mob-${idx}-${i2}`);
          if (chk && chk.checked) done.push(it);
        });
      });
      const notes = document.getElementById("notes").value;
      const payload = {
        date: todayStr(),
        type: "Movilidad",
        mobility_done: done,
        notes
      };
      const all = getSessions();
      all.push(payload);
      saveSessions(all);
      alert("Sesi√≥n de movilidad guardada ‚úÖ");
    }

    // ======== HISTORIAL ========
    function renderHistory(){
      const historyDiv = document.getElementById("history");
      const data = getSessions().slice().reverse();
      if (!data.length){
        historyDiv.innerHTML = "<p class='small'>No hay sesiones a√∫n.</p>";
        historyDiv.style.display = "block";
        return;
      }
      let html = "<h3 style='margin-top:0;'>Historial</h3>";
      data.forEach(sess => {
        html += `<h4 style="margin-bottom:.3rem;">${sess.date} ‚Äî ${sess.type}</h4><table>`;
        if (sess.type === "A" || sess.type === "B"){
          sess.exercises.forEach(ex => {
            html += `<tr><th colspan="4" style="text-align:left;">${ex.name}</th></tr>`;
            ex.sets.forEach(s => {
              html += `<tr>
                <td>${s.label}</td>
                <td>${s.weight}</td>
                <td>${s.reps} reps</td>
                <td>${s.isPR ? "<span class='pr-badge'>üèÖ PR</span>" : (s.rpe ? "RPE "+s.rpe : "")}</td>
              </tr>`;
            });
          });
        } else if (sess.type === "Cardio"){
          html += `<tr><td>Modalidad</td><td>${sess.cardio.modality}</td><td>Duraci√≥n</td><td>${sess.cardio.duration} min</td></tr>`;
          html += `<tr><td>Zona</td><td>${sess.cardio.zone}</td><td>RPE</td><td>${sess.cardio.rpe || "-"}</td></tr>`;
        } else if (sess.type === "Movilidad"){
          html += `<tr><td colspan="4">${(sess.mobility_done || []).join("<br>")}</td></tr>`;
        }
        if (sess.notes) html += `<tr><td colspan="4"><span class="small">Notas: ${sess.notes}</span></td></tr>`;
        html += "</table><br/>";
      });
      historyDiv.innerHTML = html;
      historyDiv.style.display = "block";
      historyDiv.scrollIntoView({ behavior: "smooth" });
    }

    // ======== INIT ========
    let currentView = "strength-A";
    renderStrength("A");

    document.getElementById("loadBtn").addEventListener("click", () => {
      currentView = document.getElementById("viewSelect").value;
      document.getElementById("history").style.display = "none";
      if (currentView === "strength-A") renderStrength("A");
      else if (currentView === "strength-B") renderStrength("B");
      else if (currentView === "cardio") renderCardio();
      else if (currentView === "mobility") renderMobility();
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
      if (currentView === "strength-A") saveStrength("A");
      else if (currentView === "strength-B") saveStrength("B");
      else if (currentView === "cardio") saveCardio();
      else if (currentView === "mobility") saveMobility();
    });

    document.getElementById("viewHistoryBtn").addEventListener("click", () => {
      renderHistory();
    });

        // ======== SERVICE WORKER REGISTRATION (PWA) ========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./sw.js')
          .then(reg => {
            // fuerza a comprobar si hay nueva versi√≥n del SW cuando abres la app
            if (navigator.onLine) {
              reg.update();
            }
          })
          .catch(err => {
            console.error('Service worker registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>
